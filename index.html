<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master Bot Deriv | Pro Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #0b0e11; color: #eaecef; font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }
        .view-section { display: none; flex-direction: column; height: 100%; width: 100%; overflow-y: auto; }
        .view-section.active { display: flex; }
        #chart-container { height: 40vh; min-height: 250px; width: 100%; border-bottom: 2px solid #1e2329; }
        @media (min-width: 1024px) { #chart-container { height: 60vh; } }
        .log-win { color: #22c55e; font-weight: bold; }
        .log-loss { color: #ef4444; font-weight: bold; }

        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #22c55e; }
        input:checked + .slider:before { transform: translateX(16px); }

        #asset-selector-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; align-items: center; justify-content: center; }
        #asset-selector-modal.active { display: flex; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0b0e11; }
        ::-webkit-scrollbar-thumb { background: #1e2329; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col" onclick="app.externalClick(event)">

    <div id="asset-selector-modal" onclick="app.closeAssetSelector()">
        <div class="bg-[#1e2329] w-full max-w-md m-4 rounded-2xl border border-gray-700 overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                <span class="font-bold text-yellow-500 uppercase">Selecionar Ativo</span>
                <button onclick="app.closeAssetSelector()" class="text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div id="asset-list-container" class="max-h-[60vh] overflow-y-auto p-2"></div>
        </div>
    </div>

    <div id="view-login" class="flex-1 flex items-center justify-center p-4">
        <div class="bg-[#1e2329] p-8 rounded-2xl border border-gray-800 w-full max-w-md shadow-2xl">
            <h1 class="text-2xl font-bold text-center mb-6 text-white">Master Bot <span class="text-yellow-500">Deriv</span></h1>
            <input type="password" id="api-token" placeholder="Insira seu API Token" class="w-full bg-black border border-gray-700 rounded-xl p-4 mb-4 text-center text-white outline-none">
            <button id="btn-conectar-main" onclick="app.start()" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-4 rounded-xl transition-all">CONECTAR TERMINAL</button>
        </div>
    </div>

    <div id="view-main" class="hidden h-screen flex flex-col overflow-hidden">
        <header class="h-14 border-b border-gray-800 bg-[#1e2329] flex items-center justify-between px-4 z-50">
            <div class="flex items-center gap-4">
                <button id="menu-trigger" onclick="app.toggleMenu(event)" class="text-yellow-500 text-xl"><i class="fas fa-bars"></i></button>
                <button onclick="app.openAssetSelector()" class="flex flex-col items-start hover:bg-gray-800 p-1 px-2 rounded-lg transition-colors">
                    <span id="current-asset-name" class="text-white font-bold text-xs uppercase leading-none">Detectando Ativo...</span>
                    <span class="text-[9px] text-yellow-500 flex items-center gap-1">TROCAR ATIVO <i class="fas fa-caret-down"></i></span>
                </button>
            </div>
            
            <div class="flex flex-col items-center">
                <span class="font-bold text-yellow-500 italic uppercase text-[10px]">Pro Terminal</span>
                <div class="flex items-center gap-2">
                    <span class="text-[8px] text-gray-400">RADAR</span>
                    <label class="switch">
                        <input type="checkbox" id="scanner-toggle" onchange="app.toggleScanner()">
                        <span class="slider"></span>
                    </label>
                    <span id="status-mode" class="text-[8px] text-red-500 font-bold uppercase">OFF</span>
                </div>
            </div>

            <div id="acc-balance" class="text-md font-bold text-green-500 font-mono">$ 0.00</div>
        </header>

        <div id="ai-connection-status" class="bg-black/80 text-[9px] px-4 py-1 flex justify-between border-b border-gray-900">
            <span>ENGINE: <span id="ai-status-text" class="text-blue-400 font-bold uppercase">STANDBY</span></span>
            <span class="text-gray-600 italic">SCALPER-SNIPER-V2.5</span>
        </div>

        <div id="side-menu" class="fixed left-0 top-0 h-full w-64 bg-[#1e2329] border-r border-gray-800 transform -translate-x-full transition-transform z-[100] shadow-2xl">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                <span class="text-yellow-500 font-bold">MENU</span>
                <button onclick="app.toggleMenu()" class="text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <nav class="p-2 flex flex-col gap-1">
                <button onclick="app.switchInterface('general')" class="flex items-center gap-3 p-3 hover:bg-gray-800 rounded-xl text-left text-sm">
                    <i class="fas fa-home text-blue-400 w-5"></i> Análise Geral
                </button>
                <button onclick="app.switchInterface('manual')" class="flex items-center gap-3 p-3 hover:bg-gray-800 rounded-xl text-left text-sm">
                    <i class="fas fa-hand-pointer text-green-400 w-5"></i> Operação Manual
                </button>
                <button onclick="app.switchInterface('auto')" class="flex items-center gap-3 p-3 hover:bg-gray-800 rounded-xl text-left text-sm">
                    <i class="fas fa-robot text-purple-400 w-5"></i> Operação Automática
                </button>
                <button onclick="app.switchInterface('digits')" class="flex items-center gap-3 p-3 hover:bg-gray-800 rounded-xl text-left text-sm">
                    <i class="fas fa-fingerprint text-yellow-400 w-5"></i> Digit Sniper
                </button>
            </nav>
        </div>

        <main class="flex-1 relative overflow-hidden flex flex-col">
            <section id="interface-general" class="view-section active">
                <div id="strategy-info" class="bg-blue-900/20 px-4 py-1.5 border-b border-blue-800/30 text-[10px] flex justify-between">
                    <span id="strategy-label" class="text-blue-400 font-bold uppercase">> AGUARDANDO CICLO</span>
                    <span class="text-gray-500 italic">M1 SCALPER AGRESSIVE</span>
                </div>
                <div id="chart-container">
                    <div id="tv_widget" class="w-full h-full"></div>
                </div>
                <div class="flex-1 p-4 bg-[#0b0e11] overflow-y-auto pb-20 flex flex-col items-center">
                    <div id="analysis-report" class="w-full max-w-lg bg-gray-900 border border-gray-800 rounded-2xl p-5 text-center shadow-2xl mb-4">
                        <div id="report-content" class="text-lg font-black text-gray-700 mb-4 uppercase">Aguardando Início</div>
                        <button id="btn-gen-toggle" onclick="app.generateReport()" class="w-full py-3.5 bg-blue-600 rounded-xl font-bold shadow-lg">INICIAR ANÁLISE GERAL</button>
                    </div>

                    <div id="market-radar" class="w-full max-w-lg bg-black/40 rounded-xl p-3 border border-gray-800 hidden">
                        <h3 class="text-[9px] text-gray-500 uppercase font-bold mb-2 flex justify-between items-center">
                            <span><i class="fas fa-satellite-dish mr-2 text-blue-500"></i> Radar de Oportunidades</span>
                            <span id="radar-loading-text" class="text-[8px] animate-pulse">SCALPING...</span>
                        </h3>
                        <div id="radar-list" class="space-y-1"></div>
                    </div>
                </div>
            </section>

            <section id="interface-manual" class="view-section p-4 bg-[#0b0e11]"></section>
            <section id="interface-auto" class="view-section p-4 bg-[#0b0e11]"></section>
            <section id="interface-digits" class="view-section p-4 bg-[#0b0e11]"></section>
        </main>
        
        <footer class="h-8 bg-black border-t border-gray-800 px-4 flex items-center justify-between text-[9px] text-gray-500 font-mono">
            <span id="status-text">Terminal Pronto</span>
            <div id="result-display" class="flex gap-2"></div>
        </footer>
    </div>

    <script src="https://s3.tradingview.com/tv.js"></script>
    <script src="src/core/AnaliseGeral.js"></script>
    <script src="src/core/deriv_api.js"></script>
    <script src="src/components/auto_module.js"></script>
    <script src="src/components/manual_module.js"></script>
    <script src="src/components/digit_module.js"></script>

    <script>
        const app = {
            backendBaseURL: "https://master-bot-hpt5.onrender.com",
            analista: null,
            radarAnalista: null, // Analista isolado para o radar
            isMenuOpen: false,
            isAnalyzing: false,
            isScannerOn: false,
            isRadarProcessing: false,
            isTrading: false, 
            _analysisTimer: null,
            moduleProfits: { 'a': 0, 'm': 0, 'd': 0 },
            stats: { wins: 0, losses: 0, totalProfit: 0, totalLoss: 0 },
            currentAsset: "R_100",
            
            ASSETS: [
                { symbol_deriv: "R_10",   name: "Volatility 10 Index",      symbol_tv: "DERIV:10" },
                { symbol_deriv: "R_25",   name: "Volatility 25 Index",      symbol_tv: "DERIV:25" },
                { symbol_deriv: "R_50",   name: "Volatility 50 Index",      symbol_tv: "DERIV:50" },
                { symbol_deriv: "R_75",   name: "Volatility 75 Index",      symbol_tv: "DERIV:75" },
                { symbol_deriv: "R_100",  name: "Volatility 100 Index",     symbol_tv: "DERIV:100" },
                { symbol_deriv: "1Z10",   name: "Volatility 10 (1s)",       symbol_tv: "DERIV:10S" },
                { symbol_deriv: "1HZ15V", name: "Volatility 15 (1s)",       symbol_tv: "DERIV:15S" },
                { symbol_deriv: "1HZ100V",name: "Volatility 100 (1s)",      symbol_tv: "DERIV:100S" }
            ],

            start() {
                const token = document.getElementById('api-token').value.trim();
                if (!token) return alert("Insira o Token!");
                
                document.getElementById('btn-conectar-main').innerText = "AUTENTICANDO...";
                
                if (typeof AnaliseGeral !== 'undefined') {
                    // Inicializamos dois analistas: um para o fluxo real e outro para varredura
                    this.analista = new AnaliseGeral(this.backendBaseURL + "/analisar", "principal");
                    this.radarAnalista = new AnaliseGeral(this.backendBaseURL + "/analisar", "radar");
                }

                DerivAPI.connect(token, (res) => {
                    if (res.error) {
                        alert("Erro: " + res.error.message);
                        document.getElementById('btn-conectar-main').innerText = "CONECTAR TERMINAL";
                        return;
                    } 
                    if (res.msg_type === 'authorize') {
                        document.getElementById('view-login').style.display = 'none';
                        document.getElementById('view-main').classList.remove('hidden');
                        this.renderAssetList();
                        this.switchInterface('general');
                        
                        DerivAPI.subscribeCandles((velas) => {
                            if (this.analista) this.analista.adicionarDados(velas);
                        });

                        this.onAssetChange(this.currentAsset);
                    }
                });
            },

            renderAssetList() {
                const container = document.getElementById('asset-list-container');
                container.innerHTML = this.ASSETS.map(a => `
                    <div onclick="app.onAssetChange('${a.symbol_deriv}')" class="p-3 hover:bg-gray-800 border-b border-gray-800 cursor-pointer flex justify-between items-center transition-all">
                        <span class="text-sm font-bold text-gray-200">${a.name}</span>
                        <span class="text-[10px] text-gray-500 font-mono">${a.symbol_deriv}</span>
                    </div>
                `).join('');
            },

            openAssetSelector() {
                document.getElementById('asset-selector-modal').classList.add('active');
            },

            closeAssetSelector() {
                document.getElementById('asset-selector-modal').classList.remove('active');
            },

            onAssetChange(symbol) {
                if (this.isTrading) {
                    alert("Aguarde o fim da operação atual.");
                    return;
                }

                const assetObj = this.ASSETS.find(a => a.symbol_deriv === symbol) || this.ASSETS[4];
                this.currentAsset = assetObj.symbol_deriv;
                
                document.getElementById('current-asset-name').innerText = assetObj.name;
                this.closeAssetSelector();
                
                if (this.analista) this.analista.limparHistorico(); 
                document.getElementById('report-content').innerText = "Aguardando";
                document.getElementById('ai-status-text').innerText = "STANDBY";
                document.getElementById('ai-status-text').className = "text-blue-400 font-bold uppercase";
                document.getElementById('strategy-label').innerText = "> AGUARDANDO CICLO";
                
                if (this._analysisTimer) clearTimeout(this._analysisTimer);
                this.isAnalyzing = false;
                
                const btn = document.getElementById('btn-gen-toggle');
                if(btn) {
                    btn.innerText = "INICIAR ANÁLISE GERAL";
                    btn.classList.replace('bg-red-600', 'bg-blue-600');
                }

                this.initChart(assetObj.symbol_tv);
                
                if (DerivAPI.isAuthorized) {
                    DerivAPI.changeSymbol(this.currentAsset);
                }
            },

            initChart(tvSymbol) {
                const container = document.getElementById('tv_widget');
                if (container) container.innerHTML = '';
                try {
                    new TradingView.widget({
                        "autosize": true, 
                        "symbol": tvSymbol, 
                        "interval": "1",
                        "theme": "dark", 
                        "container_id": "tv_widget", 
                        "locale": "br",
                        "style": "1", 
                        "hide_side_toolbar": true, 
                        "allow_symbol_change": false,
                        "timezone": "Etc/UTC"
                    });
                } catch (e) {
                    console.error("TV Error:", e);
                }
            },

            toggleScanner() {
                this.isScannerOn = document.getElementById('scanner-toggle').checked;
                const status = document.getElementById('status-mode');
                const radar = document.getElementById('market-radar');
                if (this.isScannerOn) {
                    status.innerText = "ON";
                    status.classList.replace('text-red-500', 'text-green-500');
                    radar.classList.remove('hidden');
                    this.runRadarAnalysis();
                } else {
                    status.innerText = "OFF";
                    status.classList.replace('text-green-500', 'text-red-500');
                    radar.classList.add('hidden');
                }
            },

            async runRadarAnalysis() {
                if (!this.isScannerOn || this.isRadarProcessing) return;
                this.isRadarProcessing = true;
                
                const radarList = document.getElementById('radar-list');
                const loadingText = document.getElementById('radar-loading-text');
                
                radarList.innerHTML = `<div class="p-2 text-[10px] text-gray-500 italic text-center animate-pulse">Iniciando varredura estratégica...</div>`;
                
                let achados = [];

                // Ciclo Caçador: Analisa um por um sem interferir no gráfico
                for (const assetObj of this.ASSETS) {
                    if (!this.isScannerOn) break;

                    loadingText.innerText = `LENDO ${assetObj.symbol_deriv}...`;
                    
                    // Busca velas isoladas via WebSocket req_id
                    const velas = await DerivAPI.getHistoryIsolated(assetObj.symbol_deriv, 30);
                    
                    if (velas && velas.length >= 10) {
                        this.radarAnalista.limparHistorico();
                        this.radarAnalista.adicionarDados(velas);
                        
                        // Chamada ao Backend específica para o radar
                        const veredito = await this.radarAnalista.obterVereditoCompleto();
                        
                        if (veredito && veredito.direcao !== "NEUTRO") {
                            achados.push({
                                asset: assetObj.symbol_deriv,
                                name: assetObj.name,
                                direcao: veredito.direcao,
                                confianca: veredito.confianca
                            });
                        }
                    }
                }

                // Processa o TOP 3
                const top3 = achados.sort((a, b) => b.confianca - a.confianca).slice(0, 3);

                if (top3.length > 0) {
                    let html = "";
                    top3.forEach(res => {
                        const cor = res.direcao === "CALL" ? "text-green-500" : "text-red-500";
                        const border = res.direcao === "CALL" ? "border-green-500" : "border-red-500";
                        html += `
                            <div onclick="app.onAssetChange('${res.asset}')" class="flex justify-between items-center text-[10px] p-2 bg-gray-800/60 rounded mb-1 border-l-2 ${border} cursor-pointer hover:bg-gray-700 transition-all">
                                <span class="font-bold">${res.name}</span>
                                <span class="${cor} font-black">${res.direcao} (${res.confianca}%)</span>
                            </div>`;
                    });
                    radarList.innerHTML = html;
                } else {
                    radarList.innerHTML = `<div class="p-2 text-[10px] text-gray-500 text-center">Nenhuma tendência forte encontrada.</div>`;
                }

                // Lógica de Finalização e Auto-Off
                this.isRadarProcessing = false;
                this.isScannerOn = false;
                document.getElementById('scanner-toggle').checked = false;
                document.getElementById('status-mode').innerText = "OFF";
                document.getElementById('status-mode').classList.replace('text-green-500', 'text-red-500');
                loadingText.innerText = "CICLO COMPLETO";
            },

            async generateReport() {
                const btn = document.getElementById('btn-gen-toggle');
                const report = document.getElementById('report-content');
                const aiStatus = document.getElementById('ai-status-text');
                const strategyLabel = document.getElementById('strategy-label');

                if (this.isAnalyzing) {
                    this.isAnalyzing = false;
                    if (this._analysisTimer) clearTimeout(this._analysisTimer);
                    btn.innerText = "INICIAR ANÁLISE GERAL";
                    btn.classList.replace('bg-red-600', 'bg-blue-600');
                    report.innerText = "Aguardando";
                    aiStatus.innerText = "STANDBY";
                    aiStatus.className = "text-blue-400 font-bold uppercase";
                    return;
                }

                this.isAnalyzing = true;
                btn.innerText = "PARAR ANÁLISE";
                btn.classList.replace('bg-blue-600', 'bg-red-600');
                report.innerHTML = `<span class="animate-pulse text-yellow-500 text-sm italic">SINCRONIZANDO SCALPER...</span>`;
                
                if (this._analysisTimer) clearTimeout(this._analysisTimer);

                const processLoop = async () => {
                    if (!this.isAnalyzing) return;

                    try {
                        const veredito = await this.analista.obterVereditoCompleto();
                        
                        if(!veredito || veredito.direcao === "NEUTRO") {
                            const count = this.analista.historicoVelas.length;
                            report.innerHTML = `<span class="text-xs text-orange-400 font-bold uppercase">Sincronizando: ${count}/10 Velas</span>`;
                            this._analysisTimer = setTimeout(processLoop, 2000);
                            return;
                        }

                        aiStatus.innerText = "SCALPER ATIVO";
                        aiStatus.className = "text-green-500 font-bold uppercase";
                        strategyLabel.innerText = `> ${veredito.estratégia || 'AGRESSIVE V2.5'}`;
                        
                        const cor = veredito.direcao === 'CALL' ? 'text-green-500' : 'text-red-500';
                        const border = veredito.direcao === 'CALL' ? 'border-green-500' : 'border-red-500';

                        report.innerHTML = `
                            <div class="text-left bg-black/40 p-3 rounded-lg border-l-4 ${border}">
                                <p class="${cor} font-black uppercase text-xl">${veredito.direcao} <span class="text-white">(${veredito.confianca}%)</span></p>
                                <p class="text-gray-400 text-[11px] mt-2 italic leading-tight">${veredito.motivo}</p>
                            </div>`;
                        
                        this._analysisTimer = setTimeout(processLoop, 5000);
                    } catch (e) { 
                        report.innerText = "ERRO NA ENGINE"; 
                        aiStatus.innerText = "OFFLINE";
                        aiStatus.className = "text-red-500 font-bold uppercase";
                        this.isAnalyzing = false;
                        btn.innerText = "INICIAR ANÁLISE GERAL";
                        btn.classList.replace('bg-red-600', 'bg-blue-600');
                    }
                };

                processLoop();
            },

            toggleMenu(e) {
                if(e) e.stopPropagation();
                this.isMenuOpen = !this.isMenuOpen;
                document.getElementById('side-menu').style.transform = this.isMenuOpen ? 'translateX(0)' : 'translateX(-100%)';
            },

            externalClick(e) {
                if (this.isMenuOpen && !document.getElementById('side-menu').contains(e.target) && !e.target.closest('#menu-trigger')) {
                    this.toggleMenu();
                }
            },

            switchInterface(type) {
                document.querySelectorAll('.view-section').forEach(sec => sec.classList.remove('active'));
                const target = document.getElementById(`interface-${type}`);
                if (target) {
                    target.classList.add('active');
                    if (target.innerHTML.trim() === "") {
                        if (type === 'auto' && typeof AutoModule !== 'undefined') target.innerHTML = AutoModule.render();
                        if (type === 'manual' && typeof ManualModule !== 'undefined') target.innerHTML = ManualModule.render();
                        if (type === 'digits' && typeof DigitModule !== 'undefined') target.innerHTML = DigitModule.render();
                    }
                }
                if (this.isMenuOpen) this.toggleMenu();
            },

            updateFooter() {
                const net = (this.stats.totalProfit - this.stats.totalLoss);
                const display = document.getElementById('result-display');
                if (display) {
                    display.innerHTML = `
                        <span class="text-green-500">W: ${this.stats.wins}</span> | 
                        <span class="text-red-500">L: ${this.stats.losses}</span> | 
                        <span class="${net >= 0 ? 'text-green-500' : 'text-red-500'}">NET: $${net.toFixed(2)}</span>
                    `;
                }
            },

            updateModuleProfit(val, prefix) {
                this.isTrading = false; 
                this.moduleProfits[prefix] = (this.moduleProfits[prefix] || 0) + val;
                
                if (val > 0) { 
                    this.stats.wins++; 
                    this.stats.totalProfit += val; 
                } else { 
                    this.stats.losses++; 
                    this.stats.totalLoss += Math.abs(val); 
                }
                
                this.updateFooter();
                
                const statusEl = document.getElementById(`${prefix}-status`);
                if(statusEl) {
                    const statusClass = val > 0 ? 'text-green-500' : 'text-red-500';
                    const resTxt = val > 0 ? 'WIN' : 'LOSS';
                    statusEl.innerHTML += `<p class="${statusClass}">> ${resTxt} ($${val.toFixed(2)})</p>`;
                    statusEl.scrollTop = statusEl.scrollHeight;
                }
                
                const profitEl = document.getElementById(`${prefix}-val-profit`);
                if(profitEl) {
                    profitEl.innerText = `${this.moduleProfits[prefix].toFixed(2)} USD`;
                    profitEl.className = `text-xl font-black ${this.moduleProfits[prefix] >= 0 ? 'text-green-500' : 'text-red-500'}`;
                }

                if (prefix === 'a' && typeof AutoModule !== 'undefined') {
                    AutoModule.isTrading = false;
                }
                if (prefix === 'd' && typeof DigitModule !== 'undefined') {
                    DigitModule.isTrading = false;
                }
            }
        };
    </script>
</body>
</html>

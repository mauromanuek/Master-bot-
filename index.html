<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deriv SMC Pro Bot | Execu√ß√£o Real</title>
    <style>
        :root {
            --bg-dark: #0D1117;
            --panel-bg: #161B22;
            --green-profit: #00C853;
            --red-loss: #FF5252;
            --blue-accent: #2979FF;
            --yellow-alert: #FFD600;
            --text-light: #C9D1D9;
            --border-color: #30363D;
        }

        body {
            margin: 0; padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark); color: var(--text-light);
            display: grid; grid-template-columns: 320px 1fr; gap: 20px;
            height: 100vh; box-sizing: border-box;
        }

        .panel {
            background-color: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; overflow-y: auto;
        }

        h2, h3 { margin-top: 0; color: #fff; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-box { background-color: var(--bg-dark); border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 22px; font-weight: bold; margin-top: 5px; }
        
        .profit { color: var(--green-profit); }
        .loss { color: var(--red-loss); }
        .neutral { color: var(--blue-accent); }
        .alert { color: var(--yellow-alert); }

        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: bold; }
        input, select {
            width: 100%; padding: 8px; background-color: var(--bg-dark);
            border: 1px solid var(--border-color); color: white; border-radius: 5px; box-sizing: border-box;
        }

        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.3s; color: white;}
        .btn-start { background-color: #2979FF; }
        .btn-pause { background-color: #FFD600; color: black; }
        .btn-stop { background-color: #FF5252; }
        .btn-manual-rise { background-color: var(--green-profit); margin-top:10px; padding: 15px; font-size: 16px;}
        .btn-manual-fall { background-color: var(--red-loss); margin-top:10px; padding: 15px; font-size: 16px;}
        button:hover { opacity: 0.8; transform: scale(0.98); }
        button:disabled { background-color: #555; cursor: not-allowed; color: #888; }

        #log-container {
            flex-grow: 1; background-color: var(--bg-dark); border: 1px solid var(--border-color);
            border-radius: 5px; padding: 10px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px;
        }
        .log-entry { margin-bottom: 5px; padding: 6px; border-radius: 3px; border-left: 4px solid #fff; }
        .log-rise { border-left-color: var(--green-profit); background: rgba(0, 200, 83, 0.1); }
        .log-fall { border-left-color: var(--red-loss); background: rgba(255, 82, 82, 0.1); }
        .log-info { border-left-color: var(--blue-accent); }
        .log-error { border-left-color: var(--yellow-alert); background: rgba(255, 214, 0, 0.1); color: var(--yellow-alert);}
    </style>
</head>
<body>

    <!-- PAINEL ESQUERDO: CONFIGURA√á√ïES -->
    <div class="panel">
        <h2>‚öôÔ∏è Configura√ß√µes (Real/Demo)</h2>
        
        <div class="control-group">
            <label>Token da API Deriv (Read/Trade)</label>
            <input type="password" id="api-token" placeholder="Cole seu token aqui...">
        </div>

        <div class="control-group">
            <label>Ativo (Mercado)</label>
            <select id="market">
                <option value="R_100">Volatility 100 Index</option>
                <option value="R_75">Volatility 75 Index</option>
                <option value="1HZ100V">Vol 100 (1s) Index</option>
            </select>
        </div>

        <div class="control-group">
            <label>Dura√ß√£o do Contrato</label>
            <div style="display: flex; gap: 5px;">
                <input type="number" id="duration" value="5">
                <select id="duration-unit">
                    <option value="t">Ticks</option>
                    <option value="m">Minutos</option>
                </select>
            </div>
        </div>

        <div class="control-group">
            <label>Modo de Opera√ß√£o</label>
            <select id="bot-mode">
                <option value="manual">Modo Manual (Apenas Sinais)</option>
                <option value="auto_conservative">Auto: Conservador (Prob >= 80%)</option>
                <option value="auto_aggressive">Auto: Agressivo (Prob >= 60%)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Stake Inicial (USD)</label>
            <input type="number" id="stake" value="1.00" step="0.50">
        </div>

        <div class="control-group">
            <label>Gest√£o de Risco (Martingale)</label>
            <select id="risk-management">
                <option value="none">Fixo (Sem Martingale)</option>
                <option value="martingale">Martingale (Vezes 2.0)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Stop Loss Di√°rio ($)</label>
            <input type="number" id="sl" value="20">
        </div>
        <div class="control-group">
            <label>Take Profit Di√°rio ($)</label>
            <input type="number" id="tp" value="20">
        </div>

        <div class="btn-group">
            <button class="btn-start" id="btn-start" onclick="startBot()">‚ñ∂ INICIAR</button>
            <button class="btn-stop" id="btn-stop" onclick="stopBot()" disabled>‚èπ STOP</button>
        </div>
    </div>

    <!-- PAINEL DIREITO: DASHBOARD E LOGS -->
    <div class="panel">
        <h2>üìä Dashboard & Execu√ß√£o</h2>

        <div class="stats-grid">
            <div class="stat-box">
                <div>Saldo Conta</div>
                <div class="stat-value neutral" id="balance">$ 0.00</div>
            </div>
            <div class="stat-box">
                <div>Lucro/Perda Sess√£o</div>
                <div class="stat-value" id="daily-profit">$ 0.00</div>
            </div>
            <div class="stat-box">
                <div>Win Rate</div>
                <div class="stat-value alert" id="win-rate">0%</div>
            </div>
            <div class="stat-box">
                <div>Trades Feitos</div>
                <div class="stat-value neutral" id="total-trades">0 (0W / 0L)</div>
            </div>
            <div class="stat-box">
                <div>Status do Bot</div>
                <div class="stat-value" id="bot-status" style="color: gray;">Parado</div>
            </div>
            <div class="stat-box">
                <div>Pre√ßo Ao Vivo</div>
                <div class="stat-value" id="current-price">0.0000</div>
            </div>
        </div>

        <!-- An√°lise T√©cnica em Tempo Real -->
        <div style="background: var(--bg-dark); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
            <h3 style="border:none; margin-bottom: 5px;">An√°lise T√©cnica & Probabilidade: <span id="current-prob" class="alert">--%</span></h3>
            <p style="margin: 5px 0;">üìà Tend√™ncia: <strong id="trend-status">Aguardando dados...</strong></p>
            <p style="margin: 5px 0;">üïØÔ∏è Padr√£o: <strong id="candle-pattern">Analisando velas...</strong></p>
            
            <div id="manual-controls" style="display: flex; gap: 15px; margin-top: 15px;">
                <button id="btn-rise" class="btn-manual-rise" onclick="executeTrade('CALL')" disabled>üìà COMPRAR (RISE)</button>
                <button id="btn-fall" class="btn-manual-fall" onclick="executeTrade('PUT')" disabled>üìâ VENDER (FALL)</button>
            </div>
        </div>

        <h3>üìù Logs Oficiais de Execu√ß√£o (API)</h3>
        <div id="log-container">
            <div class="log-entry log-info">Aguardando inser√ß√£o de Token e inicializa√ß√£o...</div>
        </div>
    </div>

    <!-- C√ìDIGO FONTE (L√ìGICA REAL DO BOT) -->
    <script>
        const APP_ID = 121512;
        let ws;
        let isRunning = false;
        let isTrading = false; // Impede abrir m√∫ltiplas ordens ao mesmo tempo
        
        let candles = [];
        let currentStake = 0;
        let initialStake = 0;
        let currency = 'USD';

        let stats = { wins: 0, losses: 0, profit: 0.0, startBalance: 0.0, currentBalance: 0.0 };

        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log-entry log-${type}`;
            div.innerHTML = `[${time}] ${message}`;
            logContainer.prepend(div);
        }

        function updateUI() {
            document.getElementById('balance').innerText = `${stats.currentBalance.toFixed(2)} ${currency}`;
            document.getElementById('daily-profit').innerText = `$ ${stats.profit.toFixed(2)}`;
            document.getElementById('daily-profit').className = stats.profit >= 0 ? 'stat-value profit' : 'stat-value loss';
            
            const total = stats.wins + stats.losses;
            const winRate = total > 0 ? ((stats.wins / total) * 100).toFixed(1) : 0;
            document.getElementById('win-rate').innerText = `${winRate}%`;
            document.getElementById('total-trades').innerText = `${total} (${stats.wins}W / ${stats.losses}L)`;

            document.getElementById('bot-status').innerText = isTrading ? "Opera√ß√£o Aberta" : (isRunning ? "Analisando..." : "Parado");
            document.getElementById('bot-status').style.color = isTrading ? var(--yellow-alert) : (isRunning ? var(--green-profit) : "gray");
        }

        function checkLimits() {
            const sl = parseFloat(document.getElementById('sl').value);
            const tp = parseFloat(document.getElementById('tp').value);
            if (stats.profit <= -sl) {
                log(`üõë STOP LOSS ATINGIDO: -$${sl}. Bot parando.`, 'error');
                stopBot();
            } else if (stats.profit >= tp) {
                log(`üèÜ TAKE PROFIT ATINGIDO: +$${tp}. Meta batida!`, 'info');
                stopBot();
            }
        }

        function connectWebSocket() {
            const token = document.getElementById('api-token').value.trim();
            if(!token) { log('ERRO: Insira seu Token da Deriv!', 'error'); return; }

            ws = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`);

            ws.onopen = () => {
                log('Conectado ao Servidor. Autenticando...', 'info');
                ws.send(JSON.stringify({ authorize: token }));
            };

            ws.onmessage = (msg) => {
                const data = JSON.parse(msg.data);
                
                if (data.error) {
                    log(`Erro Deriv: ${data.error.message}`, 'error');
                    isTrading = false; updateUI();
                    return;
                }

                // 1. AUTENTICA√á√ÉO
                if (data.msg_type === 'authorize') {
                    stats.startBalance = data.authorize.balance;
                    stats.currentBalance = data.authorize.balance;
                    currency = data.authorize.currency;
                    log(`‚úÖ Autenticado! Conta: ${data.authorize.loginid} | Saldo: ${stats.startBalance} ${currency}`, 'info');
                    
                    initialStake = parseFloat(document.getElementById('stake').value);
                    currentStake = initialStake;

                    // Inscrever para receber velas de 1 minuto em tempo real
                    ws.send(JSON.stringify({
                        ticks_history: document.getElementById('market').value,
                        end: 'latest', count: 50, style: 'candles', granularity: 60, subscribe: 1
                    }));

                    document.getElementById('btn-rise').disabled = false;
                    document.getElementById('btn-fall').disabled = false;
                }

                // 2. RECEBER VELAS (CANDLES) E PRE√áO
                if (data.msg_type === 'ohlc') {
                    const candle = data.ohlc;
                    document.getElementById('current-price').innerText = parseFloat(candle.close).toFixed(4);
                    
                    // Adicionar na mem√≥ria do bot
                    candles.push(candle);
                    if(candles.length > 50) candles.shift();

                    analyzeMarketRealTime();
                }

                // 3. COMPRA DE CONTRATO REALIZADA
                if (data.msg_type === 'buy') {
                    const contractId = data.buy.contract_id;
                    const buyPrice = data.buy.buy_price;
                    const typeUI = data.buy.shortcode.includes('CALL') ? 'RISE' : 'FALL';
                    log(`üõí ORDEM ABERTA: ${typeUI} | ID: ${contractId} | Risco: $${buyPrice}`, typeUI === 'RISE' ? 'rise' : 'fall');
                    
                    // Inscrever para monitorar o contrato aberto at√© ele fechar
                    ws.send(JSON.stringify({ proposal_open_contract: 1, contract_id: contractId, subscribe: 1 }));
                }

                // 4. MONITORAMENTO E RESULTADO DO CONTRATO
                if (data.msg_type === 'proposal_open_contract') {
                    const contract = data.proposal_open_contract;
                    if (contract.is_sold) {
                        isTrading = false; // Libera para pr√≥xima ordem
                        const finalProfit = parseFloat(contract.profit);
                        stats.profit += finalProfit;
                        stats.currentBalance += finalProfit; // Aproxima√ß√£o, API envia balance exato em outro evento

                        const typeUI = contract.contract_type === 'CALL' ? 'RISE' : 'FALL';

                        if (finalProfit > 0) {
                            stats.wins++;
                            log(`‚úÖ WIN! Contrato Encerrado. Lucro: +$${finalProfit.toFixed(2)}`, 'rise');
                            // Reseta Martingale
                            currentStake = initialStake;
                        } else {
                            stats.losses++;
                            log(`‚ùå LOSS. Contrato Encerrado. Perda: $${finalProfit.toFixed(2)}`, 'fall');
                            // Aplica Martingale se configurado
                            if(document.getElementById('risk-management').value === 'martingale') {
                                currentStake = currentStake * 2;
                                log(`‚ö†Ô∏è Martingale Ativado. Pr√≥xima entrada ser√°: $${currentStake.toFixed(2)}`, 'info');
                            }
                        }
                        
                        updateUI();
                        checkLimits();
                    }
                }
            };
        }

        // MOTOR DE AN√ÅLISE MATEM√ÅTICA (Detectando Candlesticks Reais)
        function analyzeMarketRealTime() {
            if (!isRunning || isTrading || candles.length < 3) return;

            const curr = candles[candles.length - 1]; // Vela atual (em forma√ß√£o)
            const prev = candles[candles.length - 2]; // √öltima vela fechada
            const prev2 = candles[candles.length - 3]; // Pen√∫ltima vela fechada

            // Identificar Tend√™ncia (Comparando fechamentos recentes)
            let isUptrend = parseFloat(curr.close) > parseFloat(candles[0].close);
            document.getElementById('trend-status').innerText = isUptrend ? "Alta ‚Üó" : "Baixa ‚Üò";

            // L√≥gica B√°sica de Candlesticks baseada no seu pedido
            let probScore = 40; // Base fixa
            let signal = 'NONE';
            let reason = '';

            // An√°lise: Bullish Engulfing (Vela Verde engole Vermelha)
            let isPrevRed = parseFloat(prev.close) < parseFloat(prev.open);
            let isCurrGreen = parseFloat(curr.close) > parseFloat(curr.open);
            let bullishEngulfing = isPrevRed && isCurrGreen && (parseFloat(curr.close) > parseFloat(prev.open));

            // An√°lise: Bearish Engulfing (Vela Vermelha engole Verde)
            let isPrevGreen = parseFloat(prev.close) > parseFloat(prev.open);
            let isCurrRed = parseFloat(curr.close) < parseFloat(curr.open);
            let bearishEngulfing = isPrevGreen && isCurrRed && (parseFloat(curr.close) < parseFloat(prev.open));

            if (bullishEngulfing && isUptrend) {
                probScore += 45; signal = 'CALL'; // CALL = RISE
                reason = "Tend√™ncia de Alta + Bullish Engulfing";
                document.getElementById('candle-pattern').innerText = "Engolfo de Alta";
            } else if (bearishEngulfing && !isUptrend) {
                probScore += 45; signal = 'PUT'; // PUT = FALL
                reason = "Tend√™ncia de Baixa + Bearish Engulfing";
                document.getElementById('candle-pattern').innerText = "Engolfo de Baixa";
            } else {
                document.getElementById('candle-pattern').innerText = "Aguardando Padr√£o...";
            }

            document.getElementById('current-prob').innerText = `${probScore}%`;

            // L√ìGICA DE EXECU√á√ÉO AUTOM√ÅTICA
            const mode = document.getElementById('bot-mode').value;
            if (mode.includes('auto')) {
                let limit = mode === 'auto_conservative' ? 80 : 60;
                if (probScore >= limit && signal !== 'NONE') {
                    log(`Sinal Autom√°tico: Prob ${probScore}% | Motivo: ${reason}`, 'info');
                    executeTrade(signal);
                }
            }
        }

        function executeTrade(contractType) {
            if (!isRunning || isTrading) return;
            
            isTrading = true;
            updateUI();

            const market = document.getElementById('market').value;
            const duration = parseInt(document.getElementById('duration').value);
            const durationUnit = document.getElementById('duration-unit').value;
            const typeUI = contractType === 'CALL' ? 'RISE' : 'FALL';

            log(`‚è≥ Enviando Ordem: ${typeUI} de $${currentStake.toFixed(2)} (${duration}${durationUnit})...`, 'info');

            // Payload oficial da Deriv API para comprar contrato
            const buyRequest = {
                buy: 1,
                price: 1000, // Limite de pre√ßo m√°ximo (obrigat√≥rio pela API, coloque um valor alto para garantir)
                parameters: {
                    amount: currentStake,
                    basis: "stake",
                    contract_type: contractType, // "CALL" para Rise, "PUT" para Fall
                    currency: currency,
                    duration: duration,
                    duration_unit: durationUnit,
                    symbol: market
                }
            };

            ws.send(JSON.stringify(buyRequest));
        }

        function startBot() {
            if(!ws || ws.readyState !== WebSocket.OPEN) {
                connectWebSocket();
            }
            isRunning = true;
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-stop').disabled = false;
            log('‚ñ∂Ô∏è Bot Iniciado. Modo Real/Monitoramento Ativo.', 'info');
            updateUI();
        }

        function stopBot() {
            isRunning = false;
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-stop').disabled = true;
            document.getElementById('btn-rise').disabled = true;
            document.getElementById('btn-fall').disabled = true;
            if(ws) ws.close();
            log('‚èπ Bot Parado. Conex√£o encerrada.', 'error');
            updateUI();
        }
    </script>
</body>
</html>

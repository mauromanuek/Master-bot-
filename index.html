<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PREVIUS SNIPER v4 | Hybrid CFD Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #020408; color: #8b949e; font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        .panel { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; }
        .footer-fixed { position: fixed; bottom: 0; left: 0; right: 0; background: #010409; border-top: 2px solid #21262d; height: 110px; }
        .win-log { border-left: 3px solid #238636; background: rgba(35, 134, 54, 0.05); }
        .loss-log { border-left: 3px solid #da3633; background: rgba(218, 54, 51, 0.05); }
        .reversion-log { border-left: 3px solid #e3b341; background: rgba(227, 179, 65, 0.05); }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .score-bar { height: 4px; background: #21262d; border-radius: 2px; overflow: hidden; }
        .score-fill { height: 100%; transition: width 0.5s ease; }
        
        /* Scrollbar customizada para logs */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 2px; }
    </style>
</head>
<body class="h-screen flex flex-col p-3">

    <!-- LOGIN / SETUP -->
    <div id="setup-screen" class="flex-1 flex items-center justify-center">
        <div class="panel p-6 w-full max-w-xs border-b-4 border-blue-600 shadow-2xl">
            <h1 class="text-blue-500 font-black text-center text-sm mb-4 italic tracking-tighter">PREVIUS SNIPER INSTITUTIONAL v4</h1>
            <input type="password" id="api-token" placeholder="API TOKEN DERIV" class="w-full bg-black border border-gray-800 p-2.5 rounded text-center text-[10px] text-white outline-none focus:border-blue-500">
            <button onclick="Sniper.init()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded text-[10px] uppercase transition-all mt-4">Ativar Algoritmo H√≠brido</button>
            <div class="grid grid-cols-2 gap-2 mt-4 opacity-50">
                <div class="text-[7px] border border-gray-800 p-1 text-center italic">HYBRID_ANALYSIS</div>
                <div class="text-[7px] border border-gray-800 p-1 text-center italic">CFD_REVERSION</div>
            </div>
        </div>
    </div>

    <!-- TERMINAL DE AN√ÅLISE -->
    <div id="main-terminal" class="hidden flex-1 flex flex-col gap-2 pb-32">
        <div class="flex justify-between items-center text-[9px] font-bold text-gray-500">
            <span>CORE: <span class="text-blue-400">HYBRID ENGINE v4.0</span></span>
            <span id="acc-balance" class="text-white bg-gray-900 px-2 py-1 rounded">$ 0.00</span>
        </div>

        <!-- M√âTRICAS GERAIS -->
        <div class="flex gap-4 mb-1 px-1 border-b border-gray-800/50 pb-2">
            <div class="flex flex-col">
                <span class="text-[7px] text-gray-500 uppercase font-bold">Wins</span>
                <span id="stat-wins" class="text-green-500 text-[10px] font-black italic">0</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[7px] text-gray-500 uppercase font-bold">Losses</span>
                <span id="stat-losses" class="text-red-500 text-[10px] font-black italic">0</span>
            </div>
            <div class="flex flex-col">
                <span class="text-[7px] text-gray-500 uppercase font-bold">L√≠quido</span>
                <span id="stat-net" class="text-blue-400 text-[10px] font-black italic">$ 0.00</span>
            </div>
            <!-- Bot√£o de Limpar Logs -->
            <div class="flex-1 flex justify-end">
                 <button onclick="Sniper.clearLogs()" class="text-gray-600 hover:text-red-400 transition-colors" title="Limpar Logs Visuais">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                 </button>
            </div>
        </div>

        <!-- MONITOR VISUAL -->
        <div class="flex-1 flex flex-col overflow-hidden panel p-2 relative">
            <div class="flex justify-between items-center mb-2 px-1">
                <span class="text-[9px] text-blue-500 font-black uppercase tracking-widest">> Monitor H√≠brido (Tick + Vela)</span>
                <span id="ai-thinking" class="blink text-[8px] text-yellow-500 italic">Sincronizando...</span>
            </div>
            
            <!-- Contexto de Mercado (Velas) -->
            <div class="flex gap-2 mb-2 bg-gray-900/50 p-1.5 rounded border border-gray-800/50">
                 <div class="flex-1 text-center">
                    <span class="text-[7px] text-gray-500 block uppercase">Tend√™ncia (Velas)</span>
                    <span id="candle-trend" class="text-[9px] font-bold text-gray-300">--</span>
                 </div>
                 <div class="flex-1 text-center border-l border-gray-800">
                    <span class="text-[7px] text-gray-500 block uppercase">Confian√ßa Setup</span>
                    <span id="setup-conf" class="text-[9px] font-bold text-blue-300">--%</span>
                 </div>
            </div>

            <div id="signal-log" class="flex-1 overflow-y-auto space-y-1 pr-1 font-mono text-[10px]">
                <!-- Sinais aqui -->
            </div>
        </div>
    </div>

    <!-- BOT AUTO SNIPER -->
    <div id="footer-bot" class="hidden footer-fixed flex flex-col justify-center px-4">
        <div class="flex justify-between items-end mb-2">
            <div class="flex flex-col">
                <div class="flex items-center gap-2 mb-1">
                    <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-gray-700"></div>
                    <span id="status-text" class="text-[10px] font-black text-gray-500">BOT OFF</span>
                </div>
                <div class="flex gap-2 text-[7px] font-bold uppercase tracking-tighter text-gray-600">
                    <span>TICKS: <b id="f-tick-score">0%</b></span>
                    <span>VELAS: <b id="f-candle-score">0%</b></span>
                    <span>TOTAL: <b id="f-total-score" class="text-white">0%</b></span>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <div class="text-center">
                    <span class="text-[8px] text-gray-600 font-bold block mb-1 uppercase">Stake</span>
                    <input id="bot-stake" type="number" value="0.35" class="w-14 bg-black border border-gray-800 text-blue-400 font-bold text-[10px] p-1.5 rounded text-center outline-none">
                </div>
                <button onclick="Sniper.toggleModal(true)" class="bg-gray-800 text-gray-400 border border-gray-700 h-[30px] px-3 rounded hover:bg-gray-700 transition-all flex items-center justify-center">
                    <span class="text-xs">‚öôÔ∏è</span>
                </button>
                <button id="btn-toggle" onclick="Sniper.toggle()" class="bg-blue-900/50 text-blue-400 border border-blue-500 px-6 h-[30px] rounded font-black text-[10px] hover:bg-blue-600 hover:text-white transition-all">LIGAR AUTO (‚â•95%)</button>
            </div>
        </div>
        
        <!-- Score H√≠brido -->
        <div class="flex justify-between text-[7px] text-gray-500 mb-0.5 px-1">
            <span>PUT</span>
            <span>CALL</span>
        </div>
        <div class="score-bar relative bg-gray-800">
             <!-- Marcador de centro -->
             <div class="absolute left-1/2 w-0.5 h-full bg-gray-600 transform -translate-x-1/2 z-10"></div>
            <div id="score-fill" class="score-fill bg-blue-500 w-1/2 mx-auto"></div>
        </div>
    </div>

    <!-- MODAL DE GEST√ÉO -->
    <div id="modal-settings" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="panel p-6 w-full max-w-xs border-t-4 border-blue-500 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-blue-500 font-black text-[10px] uppercase tracking-widest">Gest√£o CFD & Risco</h2>
                <button onclick="Sniper.toggleModal(false)" class="text-gray-600 hover:text-white text-xs">‚úï</button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[8px] text-gray-500 block mb-1 uppercase font-bold tracking-tighter">Meta de Lucro (TP $)</label>
                    <input id="risk-tp" type="number" value="10.00" class="w-full bg-black border border-gray-800 p-2.5 rounded text-[11px] text-green-500 font-bold outline-none focus:border-green-500/50">
                </div>
                <div>
                    <label class="text-[8px] text-gray-500 block mb-1 uppercase font-bold tracking-tighter">Limite de Perda (SL $)</label>
                    <input id="risk-sl" type="number" value="5.00" class="w-full bg-black border border-gray-800 p-2.5 rounded text-[11px] text-red-500 font-bold outline-none focus:border-red-500/50">
                </div>
                <div class="pt-2 border-t border-gray-800">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="chk-reversion" checked class="form-checkbox h-3 w-3 text-blue-600 bg-black border-gray-800 rounded">
                        <span class="text-[9px] text-gray-400">Ativar Prote√ß√£o de Revers√£o (Sa√≠da Antecipada)</span>
                    </label>
                </div>
            </div>

            <button onclick="Sniper.toggleModal(false)" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-3 rounded text-[9px] uppercase mt-8 transition-all">Salvar Configura√ß√µes</button>
        </div>
    </div>

    <script>
        const Sniper = {
            ws: null,
            ticks: [],
            candles: [], // Buffer de velas
            activeTrade: null, // Rastreia opera√ß√£o corrente { contract_id, type, entry_price }
            
            // Vari√°veis de Estado
            obv: 0,
            isAuto: false,
            wakeLock: null,
            
            // Gest√£o e Estat√≠sticas
            stats: { wins: 0, losses: 0, net: 0 },
            risk: { tp: 10, sl: 5, reversionProtection: true },
            
            // Aprendizado B√°sico (Intra-sess√£o)
            weights: { 
                ticks: 0.6, 
                candles: 0.4 
            },
            
            learning: {
                lastSignalSource: null, // 'ticks' ou 'candles' ou 'hybrid'
                consecutiveLosses: 0
            },

            async init() {
                const token = document.getElementById('api-token').value;
                if(!token) return;
                
                this.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=121512');
                
                this.ws.onopen = () => {
                    this.ws.send(JSON.stringify({ authorize: token }));
                    this.requestWakeLock();
                };
                
                this.ws.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    
                    if(data.msg_type === 'authorize' && !data.error) {
                        this.setupUI();
                        // Subscreve Ticks
                        this.ws.send(JSON.stringify({ ticks: 'R_100', subscribe: 1 }));
                        // Subscreve Candles (1 minuto) para an√°lise h√≠brida
                        this.ws.send(JSON.stringify({ 
                            ticks_history: 'R_100', 
                            end: 'latest', 
                            style: 'candles', 
                            granularity: 60, 
                            count: 50,
                            subscribe: 1 
                        }));
                        
                        // Atualiza configs de risco iniciais
                        this.updateRiskParams();
                    }
                    
                    if(data.msg_type === 'balance') {
                        document.getElementById('acc-balance').innerText = `$ ${data.balance.balance.toFixed(2)}`;
                    }
                    
                    if(data.msg_type === 'tick') {
                        this.processTick(data.tick.quote);
                    }
                    
                    if(data.msg_type === 'ohlc') {
                        this.processCandle(data.ohlc);
                    }
                    
                    // Monitoramento de Contrato (CFD/Revers√£o)
                    if(data.msg_type === 'proposal_open_contract') {
                        this.monitorActiveTrade(data.proposal_open_contract);
                    }
                    
                    if(data.error) {
                        console.error("Erro API:", data.error.message);
                    }
                };
            },

            setupUI() {
                document.getElementById('setup-screen').classList.add('hidden');
                document.getElementById('main-terminal').classList.remove('hidden');
                document.getElementById('footer-bot').classList.remove('hidden');
            },

            updateRiskParams() {
                this.risk.tp = parseFloat(document.getElementById('risk-tp').value) || 10;
                this.risk.sl = parseFloat(document.getElementById('risk-sl').value) || 5;
                this.risk.reversionProtection = document.getElementById('chk-reversion').checked;
            },

            // ===========================================
            // üß† 1. AN√ÅLISE DE MERCADO (H√çBRIDA)
            // ===========================================
            
            processTick(price) {
                const p = parseFloat(price);
                // Buffer deslizante
                if (this.ticks.length > 0) {
                    const prev = this.ticks[this.ticks.length - 1];
                    this.obv += (p > prev) ? 1 : (p < prev ? -1 : 0);
                }
                this.ticks.push(p);
                if(this.ticks.length > 300) this.ticks.shift(); 
                
                // Analisa a cada tick, mas s√≥ toma decis√£o se tiver dados suficientes
                if(this.ticks.length >= 200 && this.candles.length >= 5) {
                    this.analyzeHybrid();
                }
            },

            processCandle(candle) {
                // Atualiza ou adiciona vela nova
                const lastCandle = this.candles[this.candles.length - 1];
                if (lastCandle && lastCandle.epoch === candle.epoch) {
                    this.candles[this.candles.length - 1] = candle; // Atualiza vela atual
                } else {
                    this.candles.push(candle); // Nova vela
                    if (this.candles.length > 50) this.candles.shift();
                    
                    // Ajuste de aprendizado ao fechar vela: se errou muito, reseta pesos
                    if(this.learning.consecutiveLosses > 2) {
                        this.weights.ticks = 0.6; // Volta ao padr√£o
                        this.weights.candles = 0.4;
                        this.learning.consecutiveLosses = 0;
                    }
                }
            },

            analyzeHybrid() {
                document.getElementById('ai-thinking').innerText = "An√°lise H√≠brida...";

                // 1. An√°lise de Ticks (Curto Prazo - Momento)
                const tickAnalysis = this.getTickAnalysis();
                
                // 2. An√°lise de Velas (M√©dio Prazo - Contexto)
                const candleAnalysis = this.getCandleAnalysis();

                // 3. Score Combinado
                let finalScore = 0;
                let direction = 'NEUTRO';

                // Normaliza dire√ß√µes para valores (CALL: 1, PUT: -1)
                const tVal = tickAnalysis.direction === 'CALL' ? 1 : -1;
                const cVal = candleAnalysis.direction === 'CALL' ? 1 : -1;

                // Se houver conflu√™ncia (ambos mesmo lado), score soma
                if (tickAnalysis.direction === candleAnalysis.direction) {
                    finalScore = (tickAnalysis.score * this.weights.ticks) + (candleAnalysis.score * this.weights.candles);
                    direction = tickAnalysis.direction;
                } else {
                    // Diverg√™ncia: vence o que tiver maior score ponderado, mas penaliza o total
                    const weightedTick = tickAnalysis.score * this.weights.ticks;
                    const weightedCandle = candleAnalysis.score * this.weights.candles;
                    
                    if(weightedTick > weightedCandle) {
                        finalScore = weightedTick - (weightedCandle * 0.5); // Penalidade por diverg√™ncia
                        direction = tickAnalysis.direction;
                    } else {
                        finalScore = weightedCandle - (weightedTick * 0.5);
                        direction = candleAnalysis.direction;
                    }
                }

                // UI Updates
                this.updateAnalysisUI(tickAnalysis, candleAnalysis, finalScore, direction);

                // L√≥gica de Entrada (Score >= 95% para Auto)
                if (finalScore >= 75) {
                    // Apenas loga se for significativo
                    // Evita spam de logs (debounce visual simples via timestamps nos logs)
                }

                if (this.isAuto && finalScore >= 95 && !this.activeTrade) {
                    this.attemptAutoTrade(direction, finalScore);
                }
            },

            getTickAnalysis() {
                const p = this.ticks;
                const last = p[p.length - 1];
                const sma200 = p.slice(-200).reduce((a,b)=>a+b)/200;
                const sma20 = p.slice(-20).reduce((a,b)=>a+b)/20;
                
                // RSI Simplificado
                let g = 0, l = 0;
                for(let i = p.length - 14; i < p.length; i++){
                    let d = p[i] - p[i-1]; d > 0 ? g += d : l -= d;
                }
                const rsi = 100 - (100 / (1 + (g / (l || 1))));

                // Bollinger Simplificado
                const dev = Math.sqrt(p.slice(-20).map(x => Math.pow(x - sma20, 2)).reduce((a, b) => a + b) / 20);
                const upBand = sma20 + (dev * 2);
                const lowBand = sma20 - (dev * 2);

                let callScore = 0, putScore = 0;

                if(last > sma200) callScore += 30; else putScore += 30; // Tend√™ncia macro dos ticks
                if(rsi < 25) callScore += 35; if(rsi > 75) putScore += 35; // Sobrecompra/venda
                if(this.obv > 5) callScore += 20; if(this.obv < -5) putScore += 20; // Fluxo
                
                // Revers√£o na Banda
                if(last <= lowBand) callScore += 15; 
                if(last >= upBand) putScore += 15;

                return {
                    direction: callScore > putScore ? 'CALL' : 'PUT',
                    score: Math.max(callScore, putScore),
                    rsi: rsi
                };
            },

            getCandleAnalysis() {
                // Pega as √∫ltimas 3 velas fechadas (ignora a atual que est√° aberta)
                const history = this.candles.slice(-4, -1); 
                if(history.length < 3) return { direction: 'NEUTRO', score: 0 };

                let score = 50; // Base
                let bulls = 0, bears = 0;

                history.forEach(c => {
                    if(c.close > c.open) bulls++; else bears++;
                });

                // EMA das velas (Close price)
                const closes = this.candles.slice(-20).map(c => parseFloat(c.close));
                const emaCandle = closes.reduce((a,b)=>a+b)/closes.length;
                const lastClose = parseFloat(this.candles[this.candles.length-1].close);

                let direction = lastClose > emaCandle ? 'CALL' : 'PUT';
                
                if(bulls === 3) { score += 30; direction = 'CALL'; } // 3 Soldados
                if(bears === 3) { score += 30; direction = 'PUT'; }  // 3 Corvos

                // Engolfo (simplificado)
                const prev = history[history.length-1];
                const curr = this.candles[this.candles.length-1]; // Vela atual (forma√ß√£o)
                
                // Se vela atual engolir a anterior a favor da tendencia
                if(direction === 'CALL' && curr.close > prev.open && prev.close < prev.open) score += 15;
                if(direction === 'PUT' && curr.close < prev.open && prev.close > prev.open) score += 15;

                return {
                    direction: direction,
                    score: Math.min(score, 100),
                    trend: lastClose > emaCandle ? 'ALTA' : 'BAIXA'
                };
            },

            updateAnalysisUI(tick, candle, total, dir) {
                // Texto de Status
                document.getElementById('f-tick-score').innerText = `${tick.score.toFixed(0)}%`;
                document.getElementById('f-candle-score').innerText = `${candle.score.toFixed(0)}%`;
                
                const totalEl = document.getElementById('f-total-score');
                totalEl.innerText = `${total.toFixed(1)}%`;
                
                // Cores din√¢micas
                if(total >= 95) totalEl.className = "text-green-400 blink";
                else if(total >= 80) totalEl.className = "text-blue-400";
                else totalEl.className = "text-gray-500";

                document.getElementById('candle-trend').innerText = candle.trend;
                document.getElementById('setup-conf').innerText = `${total.toFixed(0)}%`;

                // Barra de Score Visual
                const bar = document.getElementById('score-fill');
                // Centraliza a barra (50% √© o meio). CALL move pra direita, PUT pra esquerda
                // Escala: 0 a 100. Se CALL 80%, width deve preencher do meio pra direita.
                
                // Simplifica√ß√£o visual: 
                // Se CALL: width relativo ao score, cor verde, alinhado √† esquerda do container (mas css trick needed)
                // Para manter simples no CSS atual: usamos cor para diferenciar.
                bar.style.width = `${total}%`;
                bar.className = `score-fill mx-auto ${dir === 'CALL' ? 'bg-green-500' : 'bg-red-500'}`;
            },

            // ===========================================
            // üîÑ 2. IDENTIFICA√á√ÉO DE REVERS√ÉO & CFD
            // ===========================================

            monitorActiveTrade(contract) {
                if(!this.activeTrade) return;
                if(this.activeTrade.contract_id !== contract.contract_id) return;

                if(contract.is_sold) {
                    this.activeTrade = null;
                    this.updateStatsUI(contract.profit);
                    
                    // 7. APRENDIZAGEM B√ÅSICA
                    if(contract.profit < 0) {
                        this.learning.consecutiveLosses++;
                        // Ajusta pesos: Se errou, reduz peso da estrat√©gia que estava dominante
                        // Implementa√ß√£o simplificada: reduz o peso de Ticks se errou muito em Ticks
                        if(this.learning.consecutiveLosses >= 2) {
                            this.weights.ticks = 0.5;
                            this.weights.candles = 0.5; // Equilibra em d√∫vida
                        }
                    } else {
                        this.learning.consecutiveLosses = 0;
                    }
                    return;
                }

                const currentProfit = parseFloat(contract.profit);
                const currentPrice = parseFloat(contract.bid_price); // Pre√ßo atual de venda
                
                // L√≥gica de Revers√£o / Stop Loss / Take Profit
                let shouldSell = false;
                let reason = "";

                // Take Profit CFD
                if(currentProfit >= this.risk.tp) {
                    shouldSell = true;
                    reason = "TAKE PROFIT";
                }

                // Stop Loss CFD
                if(currentProfit <= -this.risk.sl) {
                    shouldSell = true;
                    reason = "STOP LOSS";
                }

                // Detec√ß√£o de Revers√£o (Apenas se profit > 0 ou levemente negativo para proteger)
                if(this.risk.reversionProtection && !shouldSell) {
                    const tickAnalysis = this.getTickAnalysis();
                    // Se estamos em CALL e o sinal virou forte para PUT
                    if(this.activeTrade.type === 'CALL' && tickAnalysis.direction === 'PUT' && tickAnalysis.score > 80) {
                        shouldSell = true;
                        reason = "REVERS√ÉO DETECTADA";
                    }
                    // Se estamos em PUT e sinal virou CALL
                    if(this.activeTrade.type === 'PUT' && tickAnalysis.direction === 'CALL' && tickAnalysis.score > 80) {
                        shouldSell = true;
                        reason = "REVERS√ÉO DETECTADA";
                    }
                }

                if(shouldSell) {
                    console.log(`Vendendo ${contract.contract_id}: ${reason}`);
                    this.sellContract(contract.contract_id, reason);
                }
            },

            sellContract(id, reason) {
                this.ws.send(JSON.stringify({ sell: id, price: 0 })); // Price 0 = Mercado
                
                // Log visual da revers√£o
                const box = document.getElementById('signal-log');
                const html = `
                    <div class="p-1 mb-1 rounded reversion-log">
                        <div class="flex justify-between font-black text-[8px]">
                            <span class="text-yellow-500">SA√çDA: ${reason}</span>
                        </div>
                    </div>
                `;
                box.innerHTML = html + box.innerHTML;
            },

            attemptAutoTrade(direction, score) {
                // Verifica limites globais
                const isUnderLimits = (this.stats.net < this.risk.tp || this.risk.tp === 0) && (this.stats.net > -this.risk.sl || this.risk.sl === 0);
                
                if(!isUnderLimits) {
                    this.toggle(); // Desliga se bateu meta global
                    return;
                }

                // Adiciona log de entrada
                this.logSignal(direction, score, "ENTRADA AUTO");
                this.executeTrade(direction);
            },

            executeTrade(type) {
                const stake = document.getElementById('bot-stake').value;
                
                // Envia ordem de compra
                // Importante: subscribe=1 para receber updates do contrato (necess√°rio para revers√£o)
                this.ws.send(JSON.stringify({
                    buy: 1, 
                    subscribe: 1,
                    price: parseFloat(stake),
                    parameters: { 
                        amount: parseFloat(stake), 
                        basis: 'stake', 
                        contract_type: type, 
                        currency: 'USD', 
                        duration: 1, 
                        duration_unit: 'm', 
                        symbol: 'R_100' 
                    }
                }));

                // Registra inten√ß√£o de trade para o monitor
                this.activeTrade = {
                    type: type,
                    contract_id: null // Ser√° preenchido quando receber a confirma√ß√£o de compra se necess√°rio, mas o monitor pega pelo proposal_open_contract
                };

                // No V4, n√£o desligamos o bot automaticamente ap√≥s trade, a menos que seja configurado
                // Mas mantemos um cooldown de seguran√ßa simples
                this.isAuto = false; 
                this.toggleUIState(); // Atualiza bot√£o visualmente
                
                // Cooldown de 60s antes de poder reativar auto
                setTimeout(() => {
                    if(!this.isAuto && document.getElementById('status-text').innerText.includes("PAUSA")) {
                         // L√≥gica opcional de rearmar
                    }
                }, 60000);
            },
            
            // ===========================================
            // üßæ 5. LOGS E INTERFACE
            // ===========================================

            logSignal(type, score, context) {
                const box = document.getElementById('signal-log');
                const time = new Date().toLocaleTimeString();
                
                const html = `
                    <div class="p-2 mb-1 rounded ${type === 'CALL' ? 'win-log' : 'loss-log'}">
                        <div class="flex justify-between font-black text-[9px]">
                            <span class="${type === 'CALL' ? 'text-green-500' : 'text-red-500'}">${type} (${score.toFixed(0)}%)</span>
                            <span class="text-gray-400">${time}</span>
                        </div>
                        <div class="text-[8px] text-gray-500 mt-1 uppercase">
                            CTX: ${context}
                        </div>
                    </div>
                `;
                box.innerHTML = html + box.innerHTML;
                
                // Limita hist√≥rico visual para n√£o pesar DOM
                if(box.children.length > 50) box.lastChild.remove();
            },
            
            clearLogs() {
                document.getElementById('signal-log').innerHTML = '';
            },

            updateStatsUI(profit) {
                const p = parseFloat(profit);
                if (p > 0) this.stats.wins++;
                else if (p < 0) this.stats.losses++;
                this.stats.net += p;

                document.getElementById('stat-wins').innerText = this.stats.wins;
                document.getElementById('stat-losses').innerText = this.stats.losses;
                
                const netEl = document.getElementById('stat-net');
                netEl.innerText = `${this.stats.net >= 0 ? '$' : '-$'} ${Math.abs(this.stats.net).toFixed(2)}`;
                netEl.className = `text-[10px] font-black italic ${this.stats.net >= 0 ? 'text-blue-400' : 'text-red-500'}`;
            },

            toggle() {
                this.isAuto = !this.isAuto;
                this.toggleUIState();
                this.updateRiskParams(); // Atualiza par√¢metros ao ligar
            },
            
            toggleUIState() {
                const btn = document.getElementById('btn-toggle');
                const dot = document.getElementById('status-dot');
                const txt = document.getElementById('status-text');

                if(this.isAuto) {
                    btn.innerText = "PARAR SNIPER";
                    btn.className = "bg-red-900/50 text-red-400 border border-red-500 px-6 h-[30px] rounded font-black text-[10px]";
                    dot.className = "w-2.5 h-2.5 rounded-full bg-green-500 blink";
                    txt.innerText = "AUTO ON (‚â•95%)";
                    txt.className = "text-[10px] font-black text-green-500";
                } else {
                    btn.innerText = "LIGAR AUTO (‚â•95%)";
                    btn.className = "bg-blue-900/50 text-blue-400 border border-blue-500 px-6 h-[30px] rounded font-black text-[10px] hover:bg-blue-600 hover:text-white transition-all";
                    dot.className = "w-2.5 h-2.5 rounded-full bg-gray-700";
                    txt.innerText = "BOT OFF";
                    txt.className = "text-[10px] font-black text-gray-500";
                }
            },

            toggleModal(show) {
                document.getElementById('modal-settings').classList.toggle('hidden', !show);
            },

            async requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try { this.wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
                }
            }
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PREVIUS SNIPER v3 | App</title>
    
    <!-- Configurações de App (PWA) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#020408">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2533/2533031.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #020408; color: #8b949e; font-family: 'JetBrains Mono', monospace; overflow: hidden; height: 100vh; }
        .panel { background: #0d1117; border: 1px solid #30363d; border-radius: 6px; }
        .footer-fixed { position: fixed; bottom: 0; left: 0; right: 0; background: #010409; border-top: 2px solid #21262d; height: 110px; padding-bottom:env(safe-area-inset-bottom); }
        .win-log { border-left: 3px solid #238636; background: rgba(35, 134, 54, 0.05); }
        .loss-log { border-left: 3px solid #da3633; background: rgba(218, 54, 51, 0.05); }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        .score-bar { height: 4px; background: #21262d; border-radius: 2px; overflow: hidden; margin-top: 8px; }
        .score-fill { height: 100%; transition: width 0.5s ease; }
    </style>
</head>
<body class="flex flex-col p-3">

    <!-- LOGIN -->
    <div id="setup-screen" class="flex-1 flex items-center justify-center">
        <div class="panel p-6 w-full max-w-xs border-b-4 border-blue-600 shadow-2xl">
            <h1 class="text-blue-500 font-black text-center text-sm mb-4 italic tracking-tighter">PREVIUS SNIPER APP</h1>
            <input type="password" id="api-token" placeholder="API TOKEN DERIV" class="w-full bg-black border border-gray-800 p-2.5 rounded text-center text-[10px] text-white outline-none focus:border-blue-500">
            <button onclick="Sniper.init()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded text-[10px] uppercase mt-4">Ativar Sniper App</button>
            <p id="install-hint" class="text-[7px] mt-4 text-center text-gray-500 uppercase">Instale este app na tela inicial para rodar em 2º plano</p>
        </div>
    </div>

    <!-- TERMINAL -->
    <div id="main-terminal" class="hidden flex-1 flex flex-col gap-2 pb-32">
        <div class="flex justify-between items-center text-[9px] font-bold text-gray-500">
            <span>APP_ID: 1089 | <span class="text-blue-400">INSTITUTIONAL CORE</span></span>
            <span id="acc-balance" class="text-white bg-gray-900 px-2 py-1 rounded">$ 0.00</span>
        </div>
        <div class="flex-1 flex flex-col overflow-hidden panel p-2">
            <div id="signal-log" class="flex-1 overflow-y-auto space-y-1 font-mono text-[10px]">
                <p class="analyzing text-[9px] uppercase">> Aguardando primeiro ciclo de ticks...</p>
            </div>
        </div>
    </div>

    <!-- RODAPÉ FIXO -->
    <div id="footer-bot" class="hidden footer-fixed flex flex-col justify-center px-4">
        <div class="flex justify-between items-end mb-1">
            <div class="flex flex-col">
                <div class="flex items-center gap-2 mb-1">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-gray-700"></div>
                    <span id="status-text" class="text-[9px] font-black text-gray-500 uppercase tracking-tighter">STANDBY</span>
                </div>
                <div class="flex gap-2 text-[7px] font-bold text-gray-600 uppercase">
                    <span>EMA: <b id="f-dow" class="text-gray-400">--</b></span>
                    <span>RSI: <b id="f-rsi" class="text-gray-400">--</b></span>
                </div>
            </div>
            <div class="flex gap-2">
                <input id="bot-stake" type="number" value="0.35" class="w-12 bg-black border border-gray-800 text-blue-400 font-bold text-[10px] p-1.5 rounded text-center">
                <button id="btn-toggle" onclick="Sniper.toggle()" class="bg-blue-900/40 text-blue-400 border border-blue-500 px-6 rounded font-black text-[10px] uppercase">Ligar Sniper</button>
            </div>
        </div>
        <div class="score-bar"><div id="score-fill" class="score-fill bg-blue-500 w-0"></div></div>
    </div>

    <script>
        // REGISTRO DO SERVICE WORKER (Para o App funcionar)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        const Sniper = {
            ws: null, ticks: [], isAuto: false, wakeLock: null, obv: 0,

            async init() {
                const token = document.getElementById('api-token').value;
                if(!token) return;
                this.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
                this.ws.onopen = () => {
                    this.ws.send(JSON.stringify({ authorize: token }));
                    this.requestWakeLock();
                };
                this.ws.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    if(data.msg_type === 'authorize' && !data.error) {
                        document.getElementById('setup-screen').classList.add('hidden');
                        document.getElementById('main-terminal').classList.remove('hidden');
                        document.getElementById('footer-bot').classList.remove('hidden');
                        this.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
                        this.ws.send(JSON.stringify({ ticks: 'R_100', subscribe: 1 }));
                    }
                    if(data.msg_type === 'balance') document.getElementById('acc-balance').innerText = `$ ${data.balance.balance.toFixed(2)}`;
                    if(data.msg_type === 'tick') this.processTick(data.tick.quote);
                };
            },

            async requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try { this.wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
                }
            },

            processTick(price) {
                const p = parseFloat(price);
                if (this.ticks.length > 0) {
                    const prev = this.ticks[this.ticks.length - 1];
                    this.obv += (p > prev) ? 1 : -1;
                }
                this.ticks.push(p);
                if(this.ticks.length > 200) this.ticks.shift();
                if(this.ticks.length >= 200) this.analyze();
            },

            analyze() {
                const p = this.ticks;
                const last = p[p.length - 1];
                const sma200 = p.slice(-200).reduce((a,b)=>a+b)/200;
                const sma20 = p.slice(-20).reduce((a,b)=>a+b)/20;
                
                // RSI
                let g = 0, l = 0;
                for(let i = p.length - 14; i < p.length; i++){
                    let d = p[i] - p[i-1]; d > 0 ? g += d : l -= d;
                }
                const rsi = 100 - (100 / (1 + (g / (l || 1))));

                // Pontuação Institucional
                let callScore = 0, putScore = 0;
                if(last > sma200) callScore += 30; else putScore += 30;
                if(rsi < 30) callScore += 40; if(rsi > 70) putScore += 40;
                if(this.obv > 0) callScore += 30; if(this.obv < 0) putScore += 30;

                const score = Math.max(callScore, putScore);
                const side = callScore > putScore ? 'CALL' : 'PUT';

                document.getElementById('f-dow').innerText = last > sma200 ? 'ALTA' : 'BAIXA';
                document.getElementById('f-rsi').innerText = rsi.toFixed(0);
                document.getElementById('score-fill').style.width = score + '%';
                
                if(score >= 70) this.logSignal(side, score, rsi);
                if(this.isAuto && score >= 95) this.execute(side);
            },

            logSignal(type, score, rsi) {
                const box = document.getElementById('signal-log');
                const time = new Date().toLocaleTimeString();
                const id = `sig-${time.replace(/:/g,'')}`;
                if(document.getElementById(id)) return;
                const html = `
                    <div id="${id}" class="p-2 mb-1 rounded ${type === 'CALL' ? 'win-log' : 'loss-log'}">
                        <div class="flex justify-between font-black text-[9px]">
                            <span class="${type === 'CALL' ? 'text-green-500' : 'text-red-500'}">${type} DETECTADO</span>
                            <span class="text-blue-400">SCORE: ${score}%</span>
                        </div>
                    </div>`;
                box.innerHTML = html + box.innerHTML;
            },

            toggle() {
                this.isAuto = !this.isAuto;
                const btn = document.getElementById('btn-toggle');
                document.getElementById('status-text').innerText = this.isAuto ? "SNIPER ATIVO" : "STANDBY";
                document.getElementById('status-dot').className = this.isAuto ? "w-2 h-2 rounded-full bg-green-500 blink" : "w-2 h-2 rounded-full bg-gray-700";
                btn.className = this.isAuto ? "bg-red-900/40 text-red-500 border border-red-500 px-6 rounded font-black text-[10px] uppercase" : "bg-blue-900/40 text-blue-400 border border-blue-500 px-6 rounded font-black text-[10px] uppercase";
                btn.innerText = this.isAuto ? "Parar Sniper" : "Ligar Sniper";
            },

            execute(type) {
                const stake = document.getElementById('bot-stake').value;
                this.ws.send(JSON.stringify({
                    buy: 1, price: parseFloat(stake),
                    parameters: { amount: parseFloat(stake), basis: 'stake', contract_type: type, currency: 'USD', duration: 1, duration_unit: 'm', symbol: 'R_100' }
                }));
                this.toggle();
                setTimeout(() => { if(!this.isAuto) this.toggle(); }, 180000);
            }
        };
    </script>
</body>
</html>
